#!/bin/bash

# æ¸…ç†æ‰€æœ‰Shellè„šæœ¬ä¸­çš„å›¾æ ‡
set -euo pipefail

echo "=== æ¸…ç†æ‰€æœ‰Shellè„šæœ¬ä¸­çš„å›¾æ ‡ ==="
echo

# æŸ¥æ‰¾æ‰€æœ‰.shæ–‡ä»¶
SHELL_FILES=($(find /root/scripts-for-linux -name "*.sh" -type f))

echo "æ‰¾åˆ° ${#SHELL_FILES[@]} ä¸ªShellè„šæœ¬æ–‡ä»¶"
echo

# å®šä¹‰å›¾æ ‡æ›¿æ¢è§„åˆ™
declare -A ICON_REPLACEMENTS=(
    ["ğŸš€"]=""
    ["ğŸ“¥"]=""
    ["âŒ"]=""
    ["âœ…"]=""
    ["ğŸ§¹"]=""
    ["ğŸ”§"]=""
    ["ğŸš"]=""
    ["ğŸ› ï¸"]=""
    ["ğŸ”"]=""
    ["ğŸ³"]=""
    ["ğŸ“¦"]=""
    ["ğŸ¯"]=""
    ["ğŸ’¡"]=""
    ["ğŸ”„"]=""
    ["âš ï¸"]=""
    ["ğŸ“"]=""
    ["ğŸ“‹"]=""
    ["ğŸ¨"]=""
    ["ğŸ‰"]=""
    ["ğŸ”"]=""
    ["ğŸŒ"]=""
    ["ğŸ‘¤"]=""
    ["ğŸ"]=""
    ["â­ï¸"]=""
    ["ğŸ”Œ"]=""
    ["âš™ï¸"]=""
    ["ğŸ“"]=""
    ["1ï¸âƒ£"]="1."
    ["2ï¸âƒ£"]="2."
    ["3ï¸âƒ£"]="3."
    ["4ï¸âƒ£"]="4."
    ["5ï¸âƒ£"]="5."
    ["6ï¸âƒ£"]="6."
    ["7ï¸âƒ£"]="7."
    ["8ï¸âƒ£"]="8."
    ["9ï¸âƒ£"]="9."
    ["0ï¸âƒ£"]="0."
)

# å¤„ç†æ¯ä¸ªæ–‡ä»¶
processed_count=0
for file in "${SHELL_FILES[@]}"; do
    echo "æ£€æŸ¥æ–‡ä»¶: $file"

    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åŒ…å«å›¾æ ‡
    has_icons=false
    for icon in "${!ICON_REPLACEMENTS[@]}"; do
        if grep -q "$icon" "$file" 2>/dev/null; then
            has_icons=true
            break
        fi
    done

    if [ "$has_icons" = true ]; then
        echo "  å‘ç°å›¾æ ‡ï¼Œæ­£åœ¨æ¸…ç†..."

        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
        temp_file=$(mktemp)
        cp "$file" "$temp_file"

        # åº”ç”¨æ‰€æœ‰æ›¿æ¢
        for icon in "${!ICON_REPLACEMENTS[@]}"; do
            replacement="${ICON_REPLACEMENTS[$icon]}"
            # ä½¿ç”¨sedè¿›è¡Œæ›¿æ¢ï¼Œå¤„ç†ç‰¹æ®Šå­—ç¬¦
            if grep -q "$icon" "$temp_file" 2>/dev/null; then
                # ä½¿ç”¨perlè¿›è¡Œæ›´å®‰å…¨çš„æ›¿æ¢
                perl -i -pe "s/\Q$icon\E/$replacement/g" "$temp_file" 2>/dev/null || true
            fi
        done

        # æ›¿æ¢å›åŸæ–‡ä»¶
        mv "$temp_file" "$file"
        echo "  âœ“ æ¸…ç†å®Œæˆ"
        ((processed_count++))
    else
        echo "  âœ“ æ— å›¾æ ‡ï¼Œè·³è¿‡"
    fi
done

echo
echo "=== æ¸…ç†å®Œæˆ ==="
echo "å¤„ç†äº† $processed_count ä¸ªåŒ…å«å›¾æ ‡çš„æ–‡ä»¶"

# éªŒè¯æ¸…ç†ç»“æœ
echo
echo "=== éªŒè¯æ¸…ç†ç»“æœ ==="
remaining_icons=0
for file in "${SHELL_FILES[@]}"; do
    for icon in "${!ICON_REPLACEMENTS[@]}"; do
        if grep -q "$icon" "$file" 2>/dev/null; then
            echo "è­¦å‘Š: $file ä¸­ä»æœ‰å›¾æ ‡ $icon"
            ((remaining_icons++))
        fi
    done
done

if [ $remaining_icons -eq 0 ]; then
    echo "âœ“ æ‰€æœ‰å›¾æ ‡å·²æˆåŠŸæ¸…ç†"
else
    echo "âš  ä»æœ‰ $remaining_icons ä¸ªå›¾æ ‡æœªæ¸…ç†"
fi
