# =============================================================================
# APT 安装速度优化配置
# 作者: saul
# 描述: 优化 APT 安装过程，减少触发器处理时间
# =============================================================================

# 基本优化选项
APT::Get::Assume-Yes "true";
APT::Get::Fix-Broken "true";
APT::Get::Force-Yes "false";

# 减少不必要的推荐包安装
APT::Install-Recommends "false";
APT::Install-Suggests "false";

# 优化下载和安装过程
Acquire::Retries "3";
Acquire::http::Timeout "10";
Acquire::https::Timeout "10";

# DPkg 优化选项
DPkg::Options {
    "--force-confdef";
    "--force-confold";
    "--force-overwrite";
}

# 触发器优化 - 延迟处理
DPkg::TriggersPending "true";
DPkg::ConfigurePending "true";

# 减少 fsync 调用以提高性能
DPkg::Use-Pty "false";

# 优化 man-db 触发器处理
DPkg::Pre-Install-Pkgs {
    "/bin/sh -c 'export DEBIAN_FRONTEND=noninteractive; if [ -x /usr/bin/mandb ]; then /usr/bin/mandb --quiet --create 2>/dev/null || true; fi' sh";
};

# 批量处理触发器
DPkg::Post-Invoke {
    "if [ -d /var/lib/update-notifier ]; then touch /var/lib/update-notifier/dpkg-run-stamp; fi";
    "/bin/sh -c 'if [ -x /usr/bin/update-mime-database ]; then /usr/bin/update-mime-database /usr/share/mime 2>/dev/null || true; fi' sh";
};

# 减少日志输出
quiet "1";

# 禁用不必要的钩子
DPkg::Pre-Invoke "";
DPkg::Post-Invoke::= "";

# 优化缓存处理
Dir::Cache::pkgcache "";
Dir::Cache::srcpkgcache "";

# 环境变量设置
DPkg::Options::= "--force-confdef";
DPkg::Options::= "--force-confold";
DPkg::Options::= "--force-overwrite";

# 减少触发器等待时间
DPkg::StopOnError "false";

# 批处理模式
APT::Get::Show-Progress "false";
APT::Color "false";

# 优化网络设置
Acquire::http::Pipeline-Depth "5";
Acquire::Queue-Mode "host";

# 减少不必要的验证
APT::Get::AllowUnauthenticated "false";
Acquire::AllowInsecureRepositories "false";

# 内存优化
APT::Cache-Start "20971520";
APT::Cache-Grow "1048576";
APT::Cache-Limit "25165824";
